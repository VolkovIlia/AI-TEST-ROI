# Методика Использования Скрипта Расчета Эффектов и ROI (`roi_calculator.py`)

## 1. Назначение Скрипта

Этот скрипт предназначен для автоматического расчета ключевых показателей эффективности (метрик), денежных эффектов, возврата на инвестиции (ROI), а также **чистой приведенной стоимости (NPV)** и **дисконтированного ROI** от внедрения технологий искусственного интеллекта (ИИ) в процессы взаимодействия с гражданами.

Он берет исходные данные за определенные периоды (например, полгода или год) из CSV файла, включая **ставку дисконтирования**, выполняет расчеты по формулам, заложенным в "Методике оценки эффектов...", и сохраняет подробные результаты в удобный Excel файл.

Скрипт также поддерживает **режим симуляции Монте-Карло** для оценки влияния неопределенности ключевых входных параметров на итоговые NPV и дисконтированный ROI, а также **визуализацию результатов** в виде графиков.

**Цель:** Предоставить кураторам и менеджерам проекта простой инструмент для:
1.  Отслеживания прогресса и оценки достигаемых эффектов по фактическим данным (детерминированный расчет).
2.  Оценки рисков и диапазона возможных финансовых результатов проекта с учетом неопределенности входных данных (симуляция Монте-Карло).
3.  Наглядного представления динамики проекта и результатов моделирования (графики).

## 2. Как Пользоваться Скриптом

### 2.1. Подготовка Входных Данных (CSV Файл)

1.  **Создайте CSV файл** (например, `my_project_data.csv`) с помощью Excel или другого редактора таблиц.
2.  **Первая строка** должна содержать **точные** заголовки столбцов, как указано ниже. Порядок столбцов не важен, но **названия критичны**.
3.  **Каждая последующая строка** представляет **один отчетный период** (например, "Год 1.5", "Год 2.0"). **Важно:** Первая строка с данными должна соответствовать базовому периоду (Год 0), последующие строки должны идти с постоянным шагом (например, 0.5 года).
4.  **Заполните ячейки** соответствующими данными за каждый период. Используйте только числа для числовых полей (без "руб.", "часов", "%" и т.п.). Если данных за какой-то период по какому-то показателю нет, оставьте ячейку пустой или поставьте 0.

**Обязательные Заголовки Столбцов и Их Значение:**

*   `Период` (Текст): Название отчетного периода (например, "Год 1", "2.5 года").
*   `Период_Отчетности_Дни` (Число): Количество календарных дней в этом периоде.
*   `Общее_Число_Запросов` (Число): Сколько всего запросов обработано за период.
*   `Суммарное_Время_Обработки_Всех_Запросов_Часы` (Число): Общее время в часах, потраченное на обработку всех этих запросов.
*   `Среднее_Время_Обработки_До_ИИ_Часы` (Число): Какое было среднее время обработки одного запроса *до* внедрения ИИ (используется для расчета экономии). Это значение обычно одинаково для всех периодов после внедрения.
*   `Общие_Операционные_Затраты_На_Обработку_Руб` (Число): Суммарные расходы (зарплаты, инфраструктура и т.д.) на обработку запросов за период.
*   `Число_Оценок_Хорошо_Отлично_CSAT` (Число): Количество оценок "хорошо" и "отлично" в опросах удовлетворенности (CSAT).
*   `Общее_Число_Оценок_CSAT` (Число): Сколько всего оценок CSAT было собрано.
*   `Число_Промоутеров_NPS` (Число): Количество "промоутеров" (высокие оценки) в опросе лояльности (NPS).
*   `Число_Детракторов_NPS` (Число): Количество "детракторов" (низкие оценки) в опросе NPS.
*   `Общее_Число_Опрошенных_NPS` (Число): Сколько всего человек участвовало в опросе NPS.
*   `Число_Решенных_С_Первого_Раза` (Число): Сколько запросов было полностью решено за одно обращение (FCR).
*   `Число_Жалоб` (Число): Количество официальных жалоб.
*   `Число_Повторных_Обращений` (Число): Сколько раз граждане обращались повторно по тому же вопросу.
*   `Число_Решенных_В_Срок` (Число): Сколько запросов обработано в установленный нормативный срок.
*   `Число_Ошибок_Корректировок` (Число): Сколько раз приходилось исправлять ошибки в ответах/решениях.
*   `Число_Обращений_Высокий_Приоритет` (Число): Количество срочных/важных запросов.
*   `Суммарное_Время_Реакции_Высокий_Приоритет_Часы` (Число): Общее время ожидания *начала* обработки для срочных запросов.
*   `Число_Обращений_Низкий_Приоритет` (Число): Количество обычных (не срочных) запросов.
*   `Суммарное_Время_Решения_Низкий_Приоритет_Часы` (Число): Общее время *полного* решения для обычных запросов.
*   `Число_Обращений_С_Прогнозом` (Число): Для скольких запросов ИИ дал прогноз по сроку решения.
*   `Суммарная_Абсолютная_Ошибка_Прогноза_Часы` (Число): Сумма разниц (по модулю) между прогнозом ИИ и реальным временем решения.
*   `Число_Решенных_В_Срок_ИИ` (Число): Сколько запросов было решено в срок, предсказанный ИИ.
*   `Число_Запросов_Статус` (Число): Сколько раз граждане обращались просто узнать статус своего запроса.
*   `Общее_Число_Текстовых_Запросов` (Число): Сколько запросов поступило в текстовом виде (чат, email).
*   `Число_Текстовых_Обработано_ИИ` (Число): Сколько из текстовых запросов полностью обработал ИИ (без человека).
*   `Число_Текстовых_Правильно_Интерпретировано` (Число): Сколько текстовых запросов ИИ понял правильно (определил намерение).
*   `Суммарное_Время_Обработки_Текстовых_Часы` (Число): Общее время обработки всех текстовых запросов.
*   `Среднее_Время_Обработки_Текстовых_Вручную_Часы` (Число): Сколько в среднем времени тратил сотрудник на 1 текстовый запрос *до* внедрения ИИ.
*   `Индекс_Удовлетворенности_Госуслугами_Процент` (Число): Общий индекс удовлетворенности (из внешних опросов).
*   `Уровень_Доверия_ИИ_Процент` (Число): Уровень доверия к ИИ (из внешних опросов).
*   `Число_Онлайн_Запросов` (Число): Количество запросов через цифровые каналы.
*   `Число_Офлайн_Запросов` (Число): Количество запросов через традиционные каналы (визиты, звонки).
*   `Число_Положительных_Отзывов` (Число): Количество благодарностей и позитивных отзывов.
*   `Число_Негативных_Отзывов` (Число): Количество негативных отзывов (помимо жалоб).
*   `Стоимость_Часа_Сотрудника_Руб` (Число): **Константа.** Средняя стоимость часа работы сотрудника (для расчета экономии). Может меняться от периода к периоду.
*   `Затраты_На_Проект_За_Период_Руб` (Число): **Константа.** Сумма затрат на ИИ (разработка, поддержка, лицензии) за данный отчетный период.
*   `Ставка_Дисконтирования_Годовая_%` (Число): **Константа.** Годовая ставка дисконтирования, используемая для приведения будущих денежных потоков к текущей стоимости (например, 10 для 10%). Может меняться от периода к периоду.

*(Пример заполненного файла см. в `input_data.csv`)*

### 2.2. Запуск Скрипта

1.  Откройте терминал или командную строку.
2.  Перейдите в папку, где находится скрипт `roi_calculator.py` и ваше виртуальное окружение `myenv`.
3.  **Для стандартного (детерминированного) расчета:**
    Выполните команду:
    ```bash
    ./myenv/bin/python roi_calculator.py <путь_к_вашему_файлу.csv> -o <имя_выходного_файла.xlsx> [--plot-prefix ПРЕФИКС]
    ```
    *   Замените `<путь_к_вашему_файлу.csv>` на имя вашего CSV файла.
    *   Замените `<имя_выходного_файла.xlsx>` на желаемое имя файла для результатов (по умолчанию: `results.xlsx`).
    *   `--plot-prefix ПРЕФИКС` (Необязательно): Если указать этот параметр и префикс (например, `--plot-prefix my_project`), скрипт дополнительно сохранит графики динамики NPV и ROI в файлы `my_project_npv_investments.png` и `my_project_roi_investments.png`.

4.  **Для симуляции Монте-Карло:**
    Выполните команду, добавив флаг `--simulate`:
    ```bash
    ./myenv/bin/python roi_calculator.py <путь_к_вашему_файлу.csv> --simulate [--iterations ЧИСЛО] [--plot-prefix ПРЕФИКС]
    ```
    *   Замените `<путь_к_вашему_файлу.csv>` на имя вашего CSV файла (он используется как база для симуляции).
    *   `--simulate`: Обязательный флаг для запуска симуляции.
    *   `--iterations ЧИСЛО` (Необязательно): Указывает количество итераций симуляции (например, `--iterations 5000`). По умолчанию используется 10000 итераций.
    *   `--plot-prefix ПРЕФИКС` (Необязательно): Если указать этот параметр и префикс (например, `--plot-prefix my_sim`), скрипт дополнительно сохранит графики распределения NPV/ROI и анализ чувствительности в файлы (`my_sim_npv_distribution.png`, `my_sim_roi_distribution.png`, `my_sim_sensitivity_npv.png`, `my_sim_sensitivity_roi.png`).
    *   **Внимание:** В режиме симуляции **Excel файл не создается**. Результаты (статистики по NPV и ROI) выводятся **только в консоль**.

5.  Скрипт выведет сообщения о ходе выполнения. В режиме симуляции будет отображаться индикатор прогресса.

## 3. Логика Работы Скрипта и Расчетные Формулы

Скрипт последовательно выполняет следующие шаги для каждой строки (периода) из входного CSV файла:

### 3.1. Загрузка и Проверка Данных (Общее для обоих режимов)

*   Скрипт читает указанный CSV файл.
*   Проверяет наличие необходимых столбцов (включая `Ставка_Дисконтирования_Годовая_%`). Если каких-то столбцов нет, он выводит предупреждение и считает их значения равными нулю.
*   Преобразует данные в числовых столбцах в числа, заменяя возможные ошибки (например, текст вместо числа) на ноль.

### 3.2. Расчет Метрик (Общее для обоих режимов)

На основе входных данных рассчитываются производные метрики (в детерминированном режиме они сохраняются в Excel с префиксом `Метрика_`):

*   **`Метрика_Среднее_Время_Обработки_Часы`**: `Суммарное_Время_Обработки_Всех_Запросов_Часы` / `Общее_Число_Запросов`
*   **`Метрика_Пропускная_Способность_В_День`**: `Общее_Число_Запросов` / `Период_Отчетности_Дни`
*   **`Метрика_Стоимость_Обработки_Запроса_Руб`**: `Общие_Операционные_Затраты_На_Обработку_Руб` / `Общее_Число_Запросов`
*   **`Метрика_Сэкономлено_Часов_Сотрудников`**: (`Среднее_Время_Обработки_До_ИИ_Часы` - `Метрика_Среднее_Время_Обработки_Часы`) * `Общее_Число_Запросов` (результат не может быть меньше 0)
*   **`Метрика_CSAT_%`**: `Число_Оценок_Хорошо_Отлично_CSAT` * 100 / `Общее_Число_Оценок_CSAT`
*   **`Метрика_NPS`**: (`Число_Промоутеров_NPS` - `Число_Детракторов_NPS`) * 100 / `Общее_Число_Опрошенных_NPS`
*   **`Метрика_FCR_%`**: `Число_Решенных_С_Первого_Раза` * 100 / `Общее_Число_Запросов`
*   **`Метрика_Доля_Решенных_В_Срок_%`**: `Число_Решенных_В_Срок` * 100 / `Общее_Число_Запросов`
*   **`Метрика_Уровень_Ошибок_%`**: `Число_Ошибок_Корректировок` * 100 / `Общее_Число_Запросов`
*   **`Метрика_Среднее_Время_Реакции_Выс_Приоритет_Часы`**: `Суммарное_Время_Реакции_Высокий_Приоритет_Часы` / `Число_Обращений_Высокий_Приоритет`
*   **`Метрика_Коэффициент_Приоритизации`**: (`Суммарное_Время_Решения_Низкий_Приоритет_Часы` / `Число_Обращений_Низкий_Приоритет`) / `Метрика_Среднее_Время_Реакции_Выс_Приоритет_Часы`
*   **`Метрика_MAE_Прогноза_Часы`**: `Суммарная_Абсолютная_Ошибка_Прогноза_Часы` / `Число_Обращений_С_Прогнозом`
*   **`Метрика_Доля_Соблюдения_Срока_ИИ_%`**: `Число_Решенных_В_Срок_ИИ` * 100 / `Число_Обращений_С_Прогнозом`
*   **`Метрика_Доля_Автоматизации_Текст_%`**: `Число_Текстовых_Обработано_ИИ` * 100 / `Общее_Число_Текстовых_Запросов`
*   **`Метрика_Точность_Распознавания_Текст_%`**: `Число_Текстовых_Правильно_Интерпретировано` * 100 / `Число_Текстовых_Обработано_ИИ`
*   **`Метрика_Среднее_Время_Обработки_Текст_Часы`**: `Суммарное_Время_Обработки_Текстовых_Часы` / `Общее_Число_Текстовых_Запросов`
*   **`Метрика_Доля_Онлайн_Обращений_%`**: `Число_Онлайн_Запросов` * 100 / (`Число_Онлайн_Запросов` + `Число_Офлайн_Запросов`)

*(Примечание: При делении на ноль или отсутствующие данные результат метрики принимается равным 0).*

### 3.3. Расчет Денежных Эффектов (Общее для обоих режимов)

На основе рассчитанных метрик и констант вычисляются денежные эффекты (в детерминированном режиме они сохраняются в Excel с префиксом `Эффект_`):

*   **`Эффект_Экономия_ФОТ_Руб`**: `Метрика_Сэкономлено_Часов_Сотрудников` * `Стоимость_Часа_Сотрудника_Руб`
*   **`Эффект_Экономия_На_Обработке_Текста_Руб`**: `Число_Текстовых_Обработано_ИИ` * `Среднее_Время_Обработки_Текстовых_Вручную_Часы` * `Стоимость_Часа_Сотрудника_Руб`

*(Примечание: В текущей версии скрипта рассчитываются только эти два эффекта. При необходимости можно добавить расчет других эффектов, модифицировав скрипт).*

### 3.4. Расчет ROI и NPV (Общее для обоих режимов)

*   **`Расчет_Совокупная_Выгода_Руб`**: Сумма всех рассчитанных денежных эффектов (`Эффект_Экономия_ФОТ_Руб` + `Эффект_Экономия_На_Обработке_Текста_Руб` + ...). Это **номинальная** выгода за период.
*   **`Расчет_ROI_%`**: (`Расчет_Совокупная_Выгода_Руб` - `Затраты_На_Проект_За_Период_Руб`) * 100 / `Затраты_На_Проект_За_Период_Руб`. Это **номинальный** ROI за период.
*   **`Расчет_Период_Год`**: Номер периода в годах, считая от начала проекта (базовый период = 0, следующий = 0.5, затем 1.0 и т.д.). Используется для дисконтирования.
*   **`Расчет_Фактор_Дисконтирования`**: `1 / (1 + Ставка_Дисконтирования_Годовая_% / 100) ** Расчет_Период_Год`. Коэффициент для приведения будущих денег к текущей стоимости. Для базового периода = 1.
*   **`Расчет_Дисконтированная_Выгода_Руб`**: `Расчет_Совокупная_Выгода_Руб` * `Расчет_Фактор_Дисконтирования`.
*   **`Расчет_Дисконтированные_Затраты_Руб`**: `Затраты_На_Проект_За_Период_Руб` * `Расчет_Фактор_Дисконтирования`.
*   **`Расчет_Дисконтированный_Денежный_Поток_Руб`**: `Расчет_Дисконтированная_Выгода_Руб` - `Расчет_Дисконтированные_Затраты_Руб`. Денежный поток за период, приведенный к текущей стоимости.
*   **`Расчет_NPV_Накопленный_Руб`**: Сумма дисконтированных денежных потоков всех **предыдущих и текущего** периодов. Показывает накопленную чистую приведенную стоимость проекта на данный момент.
*   **`Расчет_Дисконтированный_ROI_%`**: `Расчет_NPV_Накопленный_Руб` * 100 / (Сумма дисконтированных затрат **всех предыдущих и текущего** периодов). Показывает окупаемость инвестиций с учетом временной стоимости денег.

*(Примечание: Если затраты на проект за период равны нулю, номинальный ROI принимается равным 0%. Если накопленные дисконтированные затраты равны нулю, дисконтированный ROI принимается равным 0%).*

## 4. Режим Симуляции Монте-Карло

При запуске скрипта с флагом `--simulate` выполняется симуляция Монте-Карло для оценки влияния неопределенности на итоговые финансовые показатели проекта.

### 4.1. Логика Симуляции

1.  Скрипт читает исходные данные из CSV файла (они служат базой).
2.  Запускается цикл на указанное количество итераций (`--iterations`, по умолчанию 10000).
3.  **В каждой итерации:**
    *   Создается копия исходных данных.
    *   Для **каждого периода** в копии генерируются **случайные** значения для следующих параметров:
        *   `Затраты_На_Проект_За_Период_Руб`: По **нормальному** распределению (среднее = значение из CSV, стандартное отклонение = 15% от среднего).
        *   `Общее_Число_Запросов`: По **равномерному** распределению (в диапазоне +/- 10% от значения в CSV).
        *   `Суммарное_Время_Обработки_Всех_Запросов_Часы`: По **нормальному** распределению (среднее = значение из CSV, стандартное отклонение = 10% от среднего).
        *   *(Случайные значения автоматически ограничиваются нулем снизу).*
    *   На основе этих **случайных** входных данных выполняется **полный пересчет** всех метрик, эффектов, NPV и дисконтированного ROI для **всей таблицы** (всех периодов).
    *   **Итоговые** значения `Расчет_NPV_Накопленный_Руб` и `Расчет_Дисконтированный_ROI_%` (из **последнего** периода расчета) сохраняются для данной итерации.
    *   Также сохраняются средние значения сгенерированных входных параметров (`Затраты`, `Число запросов`, `Время обработки`) для анализа чувствительности.
4.  **После завершения всех итераций:**
    *   Скрипт анализирует собранные итоговые значения NPV и дисконтированного ROI.
    *   Рассчитывает и выводит в консоль **статистические показатели**: среднее, медиану, стандартное отклонение, 5-й и 95-й перцентили, а также вероятность получения положительного NPV.
    *   Если был указан параметр `--plot-prefix`, скрипт **сохраняет графики**:
        *   Гистограммы распределения итогового NPV и ROI.
        *   Графики анализа чувствительности (показывают, как сильно каждый из варьируемых входных параметров влияет на итоговые NPV и ROI, используется корреляция Спирмена).

### 4.2. Результат Симуляции

Результаты симуляции выводятся **в консоль** в виде статистического отчета. Excel файл в этом режиме **не создается**. Отчет выглядит примерно так:

```
--- Результаты симуляции Монте-Карло ---

Статистики для Итогового NPV:
  Среднее: 12,345,678.90 Руб
  Медиана: 11,987,654.32 Руб
  Стандартное отклонение: 2,500,000.00 Руб
  5-й перцентиль: 8,000,000.00 Руб
  95-й перцентиль: 16,500,000.00 Руб
  Вероятность положительного NPV: 99.85%

Статистики для Итогового Дисконтированного ROI:
  Среднее: 155.43%
  Медиана: 150.12%
  Стандартное отклонение: 25.80%
  5-й перцентиль: 110.50%
  95-й перцентиль: 200.75%
```

Этот отчет позволяет оценить ожидаемый диапазон финансовых результатов проекта и вероятность достижения положительной окупаемости с учетом неопределенности ключевых параметров.

Если был указан `--plot-prefix`, рядом со скриптом будут сохранены PNG файлы с графиками (гистограммы распределений и анализ чувствительности).

## 5. Результат Работы (Выходной Файл и Графики)

### 5.1. Детерминированный Расчет (без `--simulate`)

*   **Excel Файл:** Создается файл (например, `results.xlsx`), содержащий таблицу со столбцами:
    1.  `Период`
    2.  Все столбцы из вашего **входного CSV файла**.
    3.  Все рассчитанные **метрики** (столбцы с префиксом `Метрика_`).
    4.  Все рассчитанные **денежные эффекты** (столбцы с префиксом `Эффект_`).
    5.  Итоговые показатели **номинальной выгоды** и **номинального ROI**, а также **расчеты дисконтирования, NPV и дисконтированного ROI** (столбцы с префиксом `Расчет_`).
*   **Графики (если указан `--plot-prefix`):**
    *   `<префикс>_npv_investments.png`: Динамика накопленного NPV и номинальных инвестиций по годам.
    *   `<префикс>_roi_investments.png`: Динамика дисконтированного ROI и номинальных инвестиций по годам.

### 5.2. Симуляция Монте-Карло (с `--simulate`)

*   **Вывод в консоль:** Статистики распределения итогового NPV и дисконтированного ROI (среднее, медиана, ст. отклонение, перцентили, вероятность > 0).
*   **Графики (если указан `--plot-prefix`):**
    *   `<префикс>_npv_distribution.png`: Гистограмма распределения итогового NPV.
    *   `<префикс>_roi_distribution.png`: Гистограмма распределения итогового дисконтированного ROI.
    *   `<префикс>_sensitivity_npv.png`: Анализ чувствительности NPV к варьируемым параметрам.
    *   `<префикс>_sensitivity_roi.png`: Анализ чувствительности дисконтированного ROI к варьируемым параметрам.

Столбцы в Excel файле упорядочены для удобства анализа. Числовые значения отформатированы до двух знаков после запятой.